, stock_sales_seb as (
Select pl.Город, pl.Позиция, pl.ABCXYZ, pl.План_продаж, pl.Прогноз_продаж, pl.Текущий_остаток_путь, seb.Себестоимость_запаса * {{nds_rate}} as Себестоимость_запаса
FROM (
SELECT 
      [ДатыВыгрузки]
      ,[Подразделение] as Город
      ,[ГрНоменклатураЧистая] as Позиция
      ,[ABCXYZ] as ABCXYZ
      ,SUM([ПланТекМес]) as План_продаж
      ,SUM([ПрогнозТекМес]) as Прогноз_продаж
      ,SUM([ТекущийОстатокВсего]+ТоварВПутиВсего) as Текущий_остаток_путь
  FROM [Avtozakaz].[dbo].[ПланЗакупа_ДанныеДляФормыСнабжения]
  Where [ЕдИзмДляОтчетов] = 'т' and [Дивизион] Like  {{ '%' ~ div ~ '%' }} and [ГФУ] = {{gfu}} and [Подразделение] is Not Null and [ГрНоменклатураЧистая] is not Null and [ГрНоменклатураЧистая]  not like 'ГП%' 
  GROUP BY  
    ДатыВыгрузки
      ,[Подразделение]
      ,[ГрНоменклатураЧистая]
      ,[ABCXYZ]

) as pl
LEFT JOIN (
    SELECT 
        s.[Подразделение] as Город
        ,nom.ГрупповаяНоменклатура as Позиция
        ,SUM([Количество]) as Количество
        ,SUM([СтоимостьБезНДС]) as Стоимость
        ,COALESCE(SUM([СтоимостьБезНДС])/NULLIF(SUM([Количество]), 0), 0) as Себестоимость_запаса
    FROM [Avtozakaz].[dbo].[ВходСтруктураЗапасов] as zap
    LEFT JOIN (SELECT DISTINCT Наименование, ГрупповаяНоменклатура FROM PRD_ERP_PBI.[dbo].[Номенклатура]) as nom on nom.Наименование = zap.Номенклатура
    LEFT JOIN [Avtozakaz].[dbo].[_SQL_СтруктураПредприятия] as s on zap.Склад = s.Склад  
    Where CAST([dt_processed] as date) = (Select MAX(CAST(ДатыВыгрузки as date)) FROM [Avtozakaz].[dbo].[ПланЗакупа_ДанныеДляФормыСнабжения]) and [ГФУ] = {{gfu}} and [Ед_изм] = 'т' and s.Дивизион Like  {{ '%' ~ div ~ '%' }}
  GROUP BY nom.ГрупповаяНоменклатура, s.[Подразделение]

) as seb on pl.Город = seb.Город and pl.Позиция = seb.Позиция

)