, emi_last_price as (
SELECT 
       CAST([Период] as date) as Период
      ,[Подразделение] as Город
      ,[ГрупповаяНоменклатура] as Позиция
      ,AVG([Цена]) as Прайс_ЕМИ
  FROM [SmartPrice].[dbo].[ЦеныПрайсЛистЕМИ]  p, (Select ВидЦены, MAX([Период]) as Посл_период FROM [SmartPrice].[dbo].[ЦеныПрайсЛистЕМИ] Where ГруппаФинансовогоУчета = {{gfu}}  and Подразделение = {{podr}} GROUP BY [ВидЦены]) a
  Where p.[ВидЦены] Like '%Прайс' 
        and (a.Посл_период = p.Период and a.ВидЦены = p.ВидЦены)
        and p.ГруппаФинансовогоУчета = {{gfu}}
  GROUP BY  
      CAST([Период] as date)
      ,[Подразделение]
      ,[ГрупповаяНоменклатура]

)