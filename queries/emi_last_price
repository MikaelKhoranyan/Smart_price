, emi_last_price as (
SELECT 
       CAST([Период] as date) as Период
      ,[Подразделение] as Город
      ,[ГрупповаяНоменклатура] as Позиция
      ,AVG([Цена]) as Прайс_ЕМИ
  FROM [PRD_ERP_PBI].[dbo].[ЦеныНоменклатуры]  p, (Select ВидЦены, MAX([Период]) as Посл_период FROM [PRD_ERP_PBI].[dbo].[ЦеныНоменклатуры] Where ГруппаФинансовогоУчета = {{gfu}}  and Подразделение IN (Select [Подразделение] FROM [PRD_ERP_PBI].[dbo].СтруктураПредприятия Where [Дивизион] Like  {{ '%' ~ div ~ '%' }} GROUP BY [Подразделение]) GROUP BY [ВидЦены]) a
  Where p.[ВидЦены] Like '%Прайс' 
        and (a.Посл_период = p.Период and a.ВидЦены = p.ВидЦены)
        and p.ГруппаФинансовогоУчета = {{gfu}}
  GROUP BY  
      CAST([Период] as date)
      ,[Подразделение]
      ,[ГрупповаяНоменклатура]

)